<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel CSV → XLSX Export</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
      --border:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter: blur(8px);}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:18px;margin:0}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer}
    .tab-btn.active{outline:2px solid var(--accent);background:#0b1220}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;font-size:13px;margin:6px 0}
    input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    button{cursor:pointer}
    .btn{background:var(--muted)}
    .btn-primary{background:var(--accent);color:#04110a;border-color:#0c3}
    .btn-info{background:var(--accent2);border-color:#3b82f6}
    .btn-danger{background:var(--danger);border-color:#b91c1c}
    .btn-warn{background:var(--warn);border-color:#b45309}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#0b1220}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0b1220}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .hint{font-size:12px;opacity:.85}
    .status{padding:10px;border-radius:10px;margin:10px 0;background:#0b1220;border:1px solid var(--border)}
    .good{border-color:#14532d;background:#052e1a}
    .bad{border-color:#7f1d1d;background:#2a0b0b}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    a.button-link{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);text-decoration:none}
    .kbd{font-family:monospace;background:#111827;border:1px solid #374151;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#22c55e" aria-hidden="true"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5v5l4 2-.75 1.85-5.25-2.6V7h2Z"/></svg>
    <h1>Panel CSV → XLSX Export</h1>
    <div class="right hint">GitHub Pages UI • Apps Script API</div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab-btn active" data-tab="panel">Halaman 1 — Pengurusan Panel</button>
    <button class="tab-btn" data-tab="upload">Halaman 2 — Upload CSV & Eksport</button>
  </div>

  <!-- PANEL MANAGEMENT -->
  <section id="tab-panel" class="card">
    <h2>Senarai Panel</h2>
    <div class="row">
      <div class="col">
        <label>Nama Panel</label>
        <input id="panelName" placeholder="cth: AIA HEALTH SERVIS SDN BHD" />
      </div>
      <div class="col">
        <label>Kod Panel</label>
        <input id="panelCode" placeholder="cth: 300-A0001 atau AIA" />
      </div>
      <div class="col" style="max-width:180px">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="btnAddPanel">Simpan / Tambah</button>
      </div>
    </div>

    <div class="status" id="panelStatus" hidden></div>

    <div class="flex" style="margin-top:8px">
      <button class="btn btn-info" id="btnRefreshPanels">Muat Semula</button>
      <button class="btn" id="btnImportOnce" title="Import sekali dari helaian LIST PANEL ke Sheet1">Import daripada LIST PANEL (sekali)</button>
      <span class="right hint">Tip: Guna <span class="kbd">Ctrl/⌘+F</span> untuk cari pantas.</span>
    </div>

    <table id="panelTable">
      <thead>
        <tr><th>#</th><th>PanelCode</th><th>PanelName</th><th>Status</th><th>Tindakan</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- UPLOAD & EXPORT -->
  <section id="tab-upload" class="card" hidden>
    <h2>Upload CSV → Eksport .xlsx (ikut Templat)</h2>

    <div class="grid">
      <div>
        <label>Muat naik fail CSV (boleh banyak sekaligus)</label>
        <input id="csvFiles" type="file" accept=".csv,text/csv" multiple />
        <p class="hint">Sistem akan cuba <b>autokesan panel</b> berdasarkan <b>nama fail</b> yang mengandungi Kod Panel. Jika tak pasti, pilih panel secara manual di jadual.</p>
      </div>
      <div>
        <label>API Web App</label>
        <input id="apiBase" placeholder="https://script.google.com/macros/s/XXX/exec" />
        <p class="hint">URL Web App Apps Script (akhiran <span class="mono">/exec</span>).</p>
      </div>
    </div>

    <div class="status" id="uploadStatus" hidden></div>

    <div class="flex" style="margin-top:10px;">
      <button class="btn btn-info" id="btnScanFiles">Imbas Fail</button>
      <button class="btn btn-primary" id="btnProcess">Proses & Eksport .xlsx</button>
      <span class="right hint">Had: <b>1–100</b> baris setiap fail, jumlah ≤ <b>RM50,000</b> setiap fail (akan dipecah automatik di server).</span>
    </div>

    <table id="fileTable">
      <thead>
        <tr>
          <th>Fail</th>
          <th>Panel</th>
          <th>Ringkasan (anggaran klien)</th>
          <th>Tindakan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="card" id="resultsCard" hidden>
      <h3>Hasil Eksport</h3>
      <table id="resultTable">
        <thead>
          <tr><th>Panel</th><th>Nama Fail</th><th>Baris</th><th>Jumlah (RM)</th><th>Muat Turun</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ======================= KONFIGURASI ======================= */
const DEFAULT_API_BASE = 'https://script.google.com/macros/s/AKfycbwcoL2BuH__0BmXQfK3C2D_krslAb9FKqn1WBGlYOyI1G_DlULF-kVjTzxKc4AM-YI/exec';

/* ======================= UTIL RINGKAS ======================= */
function $(sel){ return document.querySelector(sel); }
function $$(sel){ return Array.from(document.querySelectorAll(sel)); }
function formatRM(n){
  if(isNaN(n)) return '-';
  try{ return new Intl.NumberFormat('ms-MY',{style:'currency',currency:'MYR'}).format(n); }
  catch(_){ return 'RM ' + Number(n).toFixed(2); }
}
function showStatus(el, text, type){
  var cls = 'status';
  if(type==='good') cls += ' good';
  else if(type==='bad') cls += ' bad';
  el.className = cls;
  el.textContent = text;
  el.hidden = false;
}
function hideStatus(el){ el.hidden = true; }

/* ======================= NAV TAB ======================= */
$$('.tab-btn').forEach(function(btn){
  btn.addEventListener('click', function(){
    $$('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
    btn.classList.add('active');
    var tab = btn.getAttribute('data-tab');
    $('#tab-panel').hidden = (tab!=='panel');
    $('#tab-upload').hidden = (tab!=='upload');
  });
});

/* ======================= API FETCH (CORS-friendly) ======================= */
function apiBase(){
  var v = $('#apiBase').value.trim();
  return v || DEFAULT_API_BASE;
}

/** Guna form-encoded supaya elak preflight CORS */
async function apiPost(payload){
  var res = await fetch(apiBase(), {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
    body: 'payload=' + encodeURIComponent(JSON.stringify(payload))
  });
  if(!res.ok){
    var t = await res.text();
    throw new Error('HTTP ' + res.status + ': ' + t);
  }
  return await res.json();
}

/* ======================= PANEL MANAGEMENT ======================= */
async function loadPanels(){
  try{
    var out = await apiPost({action:'listPanels'});
    var tb = $('#panelTable tbody');
    tb.innerHTML = '';
    (out.panels||[]).forEach(function(p, idx){
      var tr = document.createElement('tr');
      var statusHtml = p.Active ? '<span class="pill">Active</span>' : '-';
      var html = ''
        + '<td>' + (idx+1) + '</td>'
        + '<td class="mono">' + (p.PanelCode||'') + '</td>'
        + '<td>' + (p.PanelName||'') + '</td>'
        + '<td>' + statusHtml + '</td>'
        + '<td class="flex">'
          + '<button class="btn small" data-act="edit" data-code="' + (p.PanelCode||'') + '">Edit</button>'
          + '<button class="btn btn-danger small" data-act="del" data-code="' + (p.PanelCode||'') + '">Padam</button>'
        + '</td>';
      tr.innerHTML = html;
      tb.appendChild(tr);
    });
  }catch(err){
    showStatus($('#panelStatus'), 'Ralat memuat panel: ' + err.message, 'bad');
  }
}
$('#btnRefreshPanels').addEventListener('click', loadPanels);

$('#btnAddPanel').addEventListener('click', async function(){
  var name = $('#panelName').value.trim();
  var code = $('#panelCode').value.trim();
  if(!name || !code){
    showStatus($('#panelStatus'),'Isi Nama & Kod Panel','bad'); 
    return;
  }
  try{
    await apiPost({action:'createPanel', panelName:name, panelCode:code, active:true});
    showStatus($('#panelStatus'),'Panel ditambah.','good');
    $('#panelName').value=''; $('#panelCode').value='';
    await loadPanels();
  }catch(err){
    showStatus($('#panelStatus'),'Gagal tambah: ' + err.message,'bad');
  }
});

$('#panelTable').addEventListener('click', async function(e){
  var btn = e.target.closest('button'); 
  if(!btn) return;
  var code = btn.getAttribute('data-code');
  var act = btn.getAttribute('data-act');
  if(act==='del'){
    if(!confirm('Padam panel ' + code + '?')) return;
    try{
      await apiPost({action:'deletePanel', panelCode:code});
      await loadPanels();
      showStatus($('#panelStatus'),'Panel dipadam.','good');
    }catch(err){
      showStatus($('#panelStatus'),'Gagal padam: ' + err.message,'bad');
    }
  } else if(act==='edit'){
    var newName = prompt('Nama baharu untuk ' + code + ':');
    if(newName==null) return;
    var active = confirm('Tetapkan Active? OK=Active, Cancel=Inactive');
    try{
      await apiPost({action:'updatePanel', panelCode:code, newName:newName, active:active});
      await loadPanels();
      showStatus($('#panelStatus'),'Panel dikemas kini.','good');
    }catch(err){
      showStatus($('#panelStatus'),'Gagal kemas kini: ' + err.message,'bad');
    }
  }
});

$('#btnImportOnce').addEventListener('click', async function(){
  try{
    var res = await apiPost({action:'importPanelsOnce'});
    var added = (res && typeof res.added==='number') ? res.added : 0;
    showStatus($('#panelStatus'), 'Import selesai. Ditambah: ' + added + '.', 'good');
    await loadPanels();
  }catch(err){
    showStatus($('#panelStatus'), 'Gagal import: ' + err.message, 'bad');
  }
});

/* ======================= UPLOAD CSV ======================= */
var knownPanels = []; // untuk dropdown & autokesan
var pendingFiles = []; // {file, name, text, panelCode?, stats?}

async function refreshKnownPanels(){
  try{
    var out = await apiPost({action:'listPanels'});
    var arr = out && out.panels ? out.panels : [];
    knownPanels = arr.filter(function(p){ return p.Active!==false; });
  }catch(e){
    knownPanels = [];
  }
}

function panelDropdownHtml(selected){
  var options = ['<option value="">-- Pilih Panel --</option>'];
  for(var i=0;i<knownPanels.length;i++){
    var p = knownPanels[i];
    var code = (p.PanelCode||'').toUpperCase();
    var name = p.PanelName || '';
    var sel = (selected && selected.toUpperCase()===code) ? ' selected' : '';
    options.push('<option value="'+code+'"' + sel + '>'+code+' — '+name+'</option>');
  }
  return '<select class="panel-select">' + options.join('') + '</select>';
}

function inferPanelFromName(name){
  var upper = (name||'').toUpperCase();
  for(var i=0;i<knownPanels.length;i++){
    var code = (knownPanels[i].PanelCode||'').toUpperCase();
    if(code && upper.indexOf(code)>=0) return code;
  }
  return '';
}

function readFileAsText(file){
  return new Promise(function(res,rej){
    var fr = new FileReader();
    fr.onload = function(){ res(fr.result); };
    fr.onerror = rej;
    fr.readAsText(file);
  });
}

function parseCsvQuickStats(text){
  try{
    var lines = text.split(/\r?\n/);
    var rows = [];
    for(var i=0;i<lines.length;i++){
      rows.push(lines[i].split(','));
    }
    if(rows.length<2) return null;
    var header = rows[0].map(function(h){ return (h||'').trim(); });
    var idxAmount = -1, idxDate = -1;
    for(var h=0; h<header.length; h++){
      var hh = header[h].toLowerCase();
      if(idxAmount<0 && (hh.indexOf('total')>=0 || hh.indexOf('rm)')>=0)) idxAmount = h;
      if(idxDate<0 && (hh.indexOf('date')>=0 || hh.indexOf('tarikh')>=0)) idxDate = h;
    }
    var count=0, sum=0;
    var months = {};
    for(var r=1;r<rows.length;r++){
      var row = rows[r];
      if(!row || row.length===0) continue;
      var allEmpty = true;
      for(var c=0;c<row.length;c++){ if(row[c] && row[c].trim()!==''){ allEmpty=false; break; } }
      if(allEmpty) continue;
      count++;
      if(idxAmount>=0){
        var raw = (row[idxAmount]||'').replace(/[^\d\.\-]/g,'').replace(/,/g,'');
        var f = parseFloat(raw);
        if(!isNaN(f)) sum += f;
      }
      if(idxDate>=0){
        var d = new Date(row[idxDate]);
        if(!isNaN(d)){
          var mm = String(d.getMonth()+1).padStart(2,'0');
          var yy = d.getFullYear();
          var key = yy + '-' + mm;
          months[key] = (months[key]||0)+1;
        }
      }
    }
    return {count:count, sum:sum, months:months};
  }catch(e){
    return null;
  }
}

function renderFileTable(){
  var tb = $('#fileTable tbody');
  tb.innerHTML = '';
  for(var i=0;i<pendingFiles.length;i++){
    var item = pendingFiles[i];
    var statsLine = '';
    if(item.stats){
      statsLine = '<div class="small hint">Anggaran: ' + item.stats.count + ' baris, Jumlah ≈ ' + formatRM(item.stats.sum) + '</div>';
    }
    var monthDominant = '-';
    if(item.stats && item.stats.months){
      var list = Object.entries(item.stats.months).sort(function(a,b){ return b[1]-a[1]; });
      if(list.length){ monthDominant = list[0][0]; }
    }
    var inferred = item.panelCode || inferPanelFromName(item.name);
    var dropdown = panelDropdownHtml(inferred);

    var tr = document.createElement('tr');
    var html = ''
      + '<td><div class="mono">' + item.name + '</div>' + statsLine + '</td>'
      + '<td>' + dropdown + '</td>'
      + '<td><div class="small">Bulan dominan (anggaran klien): ' + monthDominant + '</div></td>'
      + '<td><button class="btn btn-danger small btn-remove">Buang</button></td>';
    tr.innerHTML = html;
    tb.appendChild(tr);
  }

  var trs = $$('#fileTable tbody tr');
  trs.forEach(function(tr, idx){
    var sel = tr.querySelector('.panel-select');
    sel.addEventListener('change', function(e){
      pendingFiles[idx].panelCode = e.target.value;
    });
    var btn = tr.querySelector('.btn-remove');
    btn.addEventListener('click', function(){
      pendingFiles.splice(idx,1);
      renderFileTable();
    });
  });
}

$('#btnScanFiles').addEventListener('click', async function(){
  var files = Array.from($('#csvFiles').files||[]);
  if(!files.length){
    showStatus($('#uploadStatus'),'Sila pilih fail CSV dahulu.','bad');
    return;
  }
  await refreshKnownPanels();
  pendingFiles = [];
  showStatus($('#uploadStatus'),'Mengimbas fail…','good');
  for(var i=0;i<files.length;i++){
    var f = files[i];
    var text = await readFileAsText(f);
    var stats = parseCsvQuickStats(text);
    pendingFiles.push({file:f, name:f.name, text:text, stats:stats});
  }
  hideStatus($('#uploadStatus'));
  renderFileTable();
});

function toBase64(file){
  return new Promise(function(resolve,reject){
    var fr = new FileReader();
    fr.onload = function(){ 
      var s = fr.result;
      var base64 = s.split(',')[1];
      resolve(base64);
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

$('#btnProcess').addEventListener('click', async function(){
  if(!pendingFiles.length){
    showStatus($('#uploadStatus'),'Tiada fail untuk diproses.','bad');
    return;
  }
  await refreshKnownPanels();
  for(var i=0;i<pendingFiles.length;i++){
    var it = pendingFiles[i];
    if(!it.panelCode){ it.panelCode = inferPanelFromName(it.name); }
    if(!it.panelCode){
      showStatus($('#uploadStatus'), 'Panel tidak ditetapkan untuk fail: ' + it.name + '. Sila pilih di dropdown.', 'bad');
      return;
    }
  }
  showStatus($('#uploadStatus'),'Memuat naik & memproses di server…','good');

  try{
    var filesPayload = [];
    for(var j=0;j<pendingFiles.length;j++){
      var it2 = pendingFiles[j];
      var b64 = await toBase64(it2.file);
      filesPayload.push({name: it2.name, content: b64, encoding: 'base64', panelCode: it2.panelCode});
    }
    var res = await apiPost({action:'processCsvFiles', files: filesPayload});
    hideStatus($('#uploadStatus'));
    var out = (res && res.files) ? res.files : [];
    var serverMsg = (res && res.message) ? String(res.message) : '';
    var tb = $('#resultTable tbody'); 
    tb.innerHTML='';
    if(!out.length){
      $('#resultsCard').hidden = false;
      var msg = serverMsg || 'Tiada fail dijana.';
      tb.innerHTML = '<tr><td colspan="5" class="small">' + msg + '</td></tr>';
      return;
    }
    for(var k=0;k<out.length;k++){
      var f = out[k];
      var tr = document.createElement('tr');
      var rowHtml = ''
        + '<td class="mono">' + f.panelCode + '</td>'
        + '<td class="mono">' + f.filename + '</td>'
        + '<td>' + f.rows + '</td>'
        + '<td>' + formatRM(f.amountSum) + '</td>'
        + '<td><a class="button-link" target="_blank" rel="noopener" href="' + f.downloadUrl + '">Muat turun</a></td>';
      tr.innerHTML = rowHtml;
      tb.appendChild(tr);
    }
    $('#resultsCard').hidden = false;
  }catch(err){
    showStatus($('#uploadStatus'), 'Ralat proses: ' + err.message, 'bad');
  }
});

/* ======================= INIT ======================= */
(async function init(){
  $('#apiBase').value = DEFAULT_API_BASE;
  await loadPanels();
  await refreshKnownPanels();
})();
</script>
</body>
</html>
