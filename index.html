<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel CSV → XLSX Export</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
      --border:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
         background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter: blur(8px);}
    .brand{display:flex;gap:10px;align-items:center}
    .brand h1{font-size:18px;margin:0}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab-btn{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer}
    .tab-btn.active{outline:2px solid var(--accent);background:#0b1220}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;font-size:13px;margin:6px 0}
    input,select,button,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)
    }
    input[readonly]{opacity:.8}
    button{cursor:pointer}
    .btn{background:var(--muted)}
    .btn-primary{background:var(--accent);color:#04110a;border-color:#0c3}
    .btn-info{background:var(--accent2);border-color:#3b82f6}
    .btn-danger{background:var(--danger);border-color:#b91c1c}
    .btn-warn{background:var(--warn);border-color:#b45309}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#0b1220}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#0b1220}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .hint{font-size:12px;opacity:.85}
    .status{padding:10px;border-radius:10px;margin:10px 0;background:#0b1220;border:1px solid var(--border)}
    .good{border-color:#14532d;background:#052e1a}
    .bad{border-color:#7f1d1d;background:#2a0b0b}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    a.button-link{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);text-decoration:none}
    .kbd{font-family:monospace;background:#111827;border:1px solid #374151;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#22c55e" aria-hidden="true"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 5v5l4 2-.75 1.85-5.25-2.6V7h2Z"/></svg>
    <h1>Panel CSV → XLSX Export</h1>
    <div class="right hint">GitHub Pages UI • Apps Script API</div>
  </div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab-btn active" data-tab="panel">Halaman 1 — Pengurusan Panel</button>
    <button class="tab-btn" data-tab="upload">Halaman 2 — Upload CSV & Eksport</button>
  </div>

  <!-- PANEL MANAGEMENT -->
  <section id="tab-panel" class="card">
    <h2>Senarai Panel</h2>
    <div class="row">
      <div class="col">
        <label>Nama Panel</label>
        <input id="panelName" placeholder="cth: AIA HEALTH SERVIS SDN BHD" />
      </div>
      <div class="col">
        <label>Kod Panel</label>
        <input id="panelCode" placeholder="cth: 300-A0001 atau AIA" />
      </div>
      <div class="col" style="max-width:180px">
        <label>&nbsp;</label>
        <button class="btn btn-primary" id="btnAddPanel">Simpan / Tambah</button>
      </div>
    </div>

    <div class="status" id="panelStatus" hidden></div>

    <div class="flex" style="margin-top:8px">
      <button class="btn btn-info" id="btnRefreshPanels">Muat Semula</button>
      <button class="btn" id="btnImportOnce" title="Import sekali dari helaian LIST PANEL ke Sheet1">Import daripada LIST PANEL (sekali)</button>
      <span class="right hint">Tip: Guna <span class="kbd">Ctrl/⌘+F</span> untuk cari pantas.</span>
    </div>

    <table id="panelTable">
      <thead>
        <tr><th>#</th><th>PanelCode</th><th>PanelName</th><th>Status</th><th>Tindakan</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- UPLOAD & EXPORT -->
  <section id="tab-upload" class="card" hidden>
    <h2>Upload CSV → Eksport .xlsx (ikut Templat)</h2>

    <div class="grid">
      <div>
        <label>Muat naik fail CSV (boleh banyak sekaligus)</label>
        <input id="csvFiles" type="file" accept=".csv,text/csv" multiple />
        <p class="hint">Sistem akan cuba **autokesan panel** berdasarkan **nama fail** yang mengandungi Kod Panel. Jika tak pasti, pilih panel secara manual di jadual.</p>
      </div>
      <div>
        <label>API Web App</label>
        <input id="apiBase" placeholder="https://script.google.com/macros/s/XXX/exec" />
        <p class="hint">Pastikan ini URL Web App Apps Script anda (<span class="mono">/exec</span>).</p>
      </div>
    </div>

    <div class="status" id="uploadStatus" hidden></div>

    <div class="flex" style="margin-top:10px;">
      <button class="btn btn-info" id="btnScanFiles">Imbas Fail</button>
      <button class="btn btn-primary" id="btnProcess">Proses & Eksport .xlsx</button>
      <span class="right hint">Had: <b>50–100</b> baris setiap fail, jumlah ≤ <b>RM50,000</b> setiap fail (akan dipecah automatik di server).</span>
    </div>

    <table id="fileTable">
      <thead>
        <tr>
          <th>Fail</th>
          <th>Panel</th>
          <th>Ringkasan (anggaran klien)</th>
          <th>Tindakan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="card" id="resultsCard" hidden>
      <h3>Hasil Eksport</h3>
      <table id="resultTable">
        <thead>
          <tr><th>Panel</th><th>Nama Fail</th><th>Baris</th><th>Jumlah (RM)</th><th>Muat Turun</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ======================= KONFIGURASI ======================= */
// Gantikan dengan URL Web App Apps Script anda (akhiran /exec).
const DEFAULT_API_BASE = 'https://script.google.com/macros/s/AKfycbwcoL2BuH__0BmXQfK3C2D_krslAb9FKqn1WBGlYOyI1G_DlULF-kVjTzxKc4AM-YI/exec';

/* ======================= UTIL RINGKAS ======================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const formatRM = n => isNaN(n) ? '-' : new Intl.NumberFormat('ms-MY',{style:'currency',currency:'MYR'}).format(n);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function showStatus(el, text, type='good'){
  el.textContent = text;
  el.className = 'status ' + (type==='good'?'good':(type==='bad'?'bad':'')); 
  el.hidden = false;
}

function hideStatus(el){ el.hidden = true; }

/* ======================= NAV TAB ======================= */
$$('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $('#tab-panel').hidden = tab!=='panel';
    $('#tab-upload').hidden = tab!=='upload';
  });
});

/* ======================= API FETCH ======================= */
function apiBase(){
  const v = $('#apiBase').value.trim();
  return v || DEFAULT_API_BASE;
}

async function apiPost(payload){
  const res = await fetch(apiBase(), {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload),
  });
  // Apps Script WebApp biasanya benarkan CORS; jika tidak, perlu laras deploy.
  if(!res.ok){
    const t = await res.text();
    throw new Error(`HTTP ${res.status}: ${t}`);
  }
  return await res.json();
}

/* ======================= PANEL MANAGEMENT ======================= */
async function loadPanels(){
  try{
    const out = await apiPost({action:'listPanels'});
    const tb = $('#panelTable tbody');
    tb.innerHTML='';
    (out.panels||[]).forEach((p,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="mono">${p.PanelCode||''}</td>
        <td>${p.PanelName||''}</td>
        <td>${p.Active?'<span class="pill">Active</span>':'-'}</td>
        <td class="flex">
          <button class="btn small" data-act="edit" data-code="${p.PanelCode}">Edit</button>
          <button class="btn btn-danger small" data-act="del" data-code="${p.PanelCode}">Padam</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(err){
    showStatus($('#panelStatus'), 'Ralat memuat panel: '+err.message, 'bad');
  }
}

$('#btnRefreshPanels').addEventListener('click', loadPanels);

$('#btnAddPanel').addEventListener('click', async ()=>{
  const name = $('#panelName').value.trim();
  const code = $('#panelCode').value.trim();
  if(!name || !code){ showStatus($('#panelStatus'),'Isi Nama & Kod Panel','bad'); return; }
  try{
    await apiPost({action:'createPanel', panelName:name, panelCode:code, active:true});
    showStatus($('#panelStatus'),'Panel ditambah.', 'good');
    $('#panelName').value=''; $('#panelCode').value='';
    await loadPanels();
  }catch(err){
    showStatus($('#panelStatus'),'Gagal tambah: '+err.message,'bad');
  }
});

$('#panelTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const code = btn.dataset.code;
  if(btn.dataset.act==='del'){
    if(!confirm('Padam panel '+code+'?')) return;
    try{
      await apiPost({action:'deletePanel', panelCode:code});
      await loadPanels();
      showStatus($('#panelStatus'),'Panel dipadam.','good');
    }catch(err){
      showStatus($('#panelStatus'),'Gagal padam: '+err.message,'bad');
    }
  }
  if(btn.dataset.act==='edit'){
    const newName = prompt('Nama baharu untuk '+code+':'); if(newName==null) return;
    const active = confirm('Tetapkan Active? OK=Active, Cancel=Inactive');
    try{
      await apiPost({action:'updatePanel', panelCode:code, newName:newName, active:active});
      await loadPanels();
      showStatus($('#panelStatus'),'Panel dikemas kini.','good');
    }catch(err){
      showStatus($('#panelStatus'),'Gagal kemas kini: '+err.message,'bad');
    }
  }
});

$('#btnImportOnce').addEventListener('click', async ()=>{
  try{
    const res = await apiPost({action:'importPanelsOnce'});
    showStatus($('#panelStatus'), `Import selesai. Ditambah: ${res.added||0}.`, 'good');
    await loadPanels();
  }catch(err){
    showStatus($('#panelStatus'), 'Gagal import: '+err.message, 'bad');
  }
});

/* ======================= UPLOAD CSV ======================= */
let knownPanels = []; // untuk dropdown & autokesan
let pendingFiles = []; // {file, name, text, panelCode?, stats?}

async function refreshKnownPanels(){
  try{
    const out = await apiPost({action:'listPanels'});
    knownPanels = (out.panels||[]).filter(p=>p.Active!==false);
  }catch(e){
    // fallback kosong
    knownPanels = [];
  }
}

function panelDropdownHtml(selected){
  const opts = knownPanels.map(p=>`<option value="${(p.PanelCode||'').toUpperCase()}" ${selected && selected.toUpperCase()===(p.PanelCode||'').toUpperCase()?'selected':''}>${(p.PanelCode||'').toUpperCase()} — ${p.PanelName||''}</option>`).join('');
  return `<select class="panel-select"><option value="">-- Pilih Panel --</option>${opts}</select>`;
}

function inferPanelFromName(name){
  const upper = (name||'').toUpperCase();
  for(const p of knownPanels){
    const code = (p.PanelCode||'').toUpperCase();
    if(code && upper.includes(code)) return code;
  }
  return '';
}

async function readFileAsText(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsText(file);
  });
}

function parseCsvQuickStats(text){
  // Anggaran klien: cari lajur “Total Payment Panel (RM)” dan kira jumlah & bilangan baris (bukan authoritative)
  try{
    const rows = text.split(/\r?\n/).map(r=>r.split(','));
    if(rows.length<2) return null;
    const header = rows[0].map(h=>h.trim());
    const idxAmount = header.findIndex(h=>/total\s*payment/i.test(h) || /rm\)/i.test(h));
    const idxDate = header.findIndex(h=>/date/i.test(h) || /tarikh/i.test(h));
    let count=0, sum=0, months={};
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      if(!r || r.length===0 || r.every(x=>!x)) continue;
      count++;
      if(idxAmount>=0){
        const raw = (r[idxAmount]||'').replace(/[^\d\.\-]/g,'').replace(/,/g,'');
        const f = parseFloat(raw); if(!isNaN(f)) sum+=f;
      }
      if(idxDate>=0){
        const d = new Date(r[idxDate]);
        if(!isNaN(d)) {
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const yy = d.getFullYear();
          const key = `${yy}-${mm}`;
          months[key] = (months[key]||0)+1;
        }
      }
    }
    return {count,sum,months};
  }catch(e){ return null; }
}

function renderFileTable(){
  const tb = $('#fileTable tbody');
  tb.innerHTML = '';
  for(const item of pendingFiles){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="mono">${item.name}</div>
        ${item.stats?`<div class="small hint">Anggaran: ${item.stats.count} baris, Jumlah ≈ ${formatRM(item.stats.sum)}</div>`:''}
      </td>
      <td>${panelDropdownHtml(item.panelCode||inferPanelFromName(item.name))}</td>
      <td>
        <div class="small">Bulan dominan (anggaran klien): ${
          item.stats && Object.keys(item.stats.months||{}).length
            ? Object.entries(item.stats.months).sort((a,b)=>b[1]-a[1])[0][0]
            : '-'
        }</div>
      </td>
      <td>
        <button class="btn btn-danger small btn-remove">Buang</button>
      </td>
    `;
    tb.appendChild(tr);
  }
  // wire selects + remove
  $$('#fileTable tbody tr').forEach((tr, idx)=>{
    const sel = tr.querySelector('.panel-select');
    sel.addEventListener('change', e=>{
      pendingFiles[idx].panelCode = e.target.value;
    });
    const btn = tr.querySelector('.btn-remove');
    btn.addEventListener('click', ()=>{
      pendingFiles.splice(idx,1);
      renderFileTable();
    });
  });
}

$('#btnScanFiles').addEventListener('click', async ()=>{
  const files = Array.from($('#csvFiles').files||[]);
  if(!files.length){ showStatus($('#uploadStatus'),'Sila pilih fail CSV dahulu.','bad'); return; }
  await refreshKnownPanels();
  pendingFiles = [];
  showStatus($('#uploadStatus'),'Mengimbas fail…','good');
  for(const f of files){
    const text = await readFileAsText(f);
    const stats = parseCsvQuickStats(text);
    pendingFiles.push({file:f, name:f.name, text, stats});
  }
  hideStatus($('#uploadStatus'));
  renderFileTable();
});

async function toBase64(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result.split(',')[1]);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

$('#btnProcess').addEventListener('click', async ()=>{
  if(!pendingFiles.length){ showStatus($('#uploadStatus'),'Tiada fail untuk diproses.','bad'); return; }
  await refreshKnownPanels();
  // Pastikan semua fail ada panelCode (sama ada infer nama fail atau pilihan manual)
  for(const it of pendingFiles){
    it.panelCode = it.panelCode || inferPanelFromName(it.name);
    if(!it.panelCode){
      showStatus($('#uploadStatus'), `Panel tidak ditetapkan untuk fail: ${it.name}. Sila pilih di dropdown.`, 'bad');
      return;
    }
  }
  showStatus($('#uploadStatus'),'Memuat naik & memproses di server… ini boleh ambil sedikit masa.','good');

  try{
    // Sediakan payload
    const filesPayload = [];
    for(const it of pendingFiles){
      const b64 = await toBase64(it.file);
      filesPayload.push({name: it.name, content: b64, encoding: 'base64', panelCode: it.panelCode});
    }
    const res = await apiPost({action:'processCsvFiles', files: filesPayload});
    hideStatus($('#uploadStatus'));
    const out = res.files || [];
    // Paparkan hasil
    const tb = $('#resultTable tbody'); tb.innerHTML='';
    if(!out.length){
      $('#resultsCard').hidden = false;
      tb.innerHTML = `<tr><td colspan="5" class="small">Tiada fail dijana.</td></tr>`;
      return;
    }
    out.forEach(f=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${f.panelCode}</td>
        <td class="mono">${f.filename}</td>
        <td>${f.rows}</td>
        <td>${formatRM(f.amountSum)}</td>
        <td><a class="button-link" target="_blank" rel="noopener" href="${f.downloadUrl}">Muat turun</a></td>
      `;
      tb.appendChild(tr);
    });
    $('#resultsCard').hidden = false;
  }catch(err){
    showStatus($('#uploadStatus'), 'Ralat proses: '+err.message, 'bad');
  }
});

/* ======================= INIT ======================= */
(async function init(){
  // Prefill API base
  $('#apiBase').value = DEFAULT_API_BASE;
  // Muat panel
  await loadPanels();
  await refreshKnownPanels();
})();
</script>
</body>
</html>
