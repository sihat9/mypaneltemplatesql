<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel CSV → SQL Template XLSX</title>
  <style>
    :root{
      --bg:#0b1020; --card:#0c1428; --stroke:#0f213b; --text:#e6eefc; --muted:#9fb2d9;
      --brand:#22c55e; --brand2:#10b981; --err:#ef4444; --ok:#22c55e;
    }
    html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg),#0a0f1a);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    *{box-sizing:border-box}
    .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
    .nav{display:flex;gap:10px;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--stroke);background:linear-gradient(180deg,#0b162b,#0b1426);color:#cde2ff;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#11244a,#0e213f);border-color:#1f3b6a}
    .card{background:linear-gradient(180deg,var(--card),#0a1326);border:1px solid var(--stroke);border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}
    .btn{background:linear-gradient(180deg,#16a34a,#22c55e);border:1px solid #22c55e;color:#052e16;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn2{background:#0b162b;border:1px solid #12315d;color:#dbeafe;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn3{background:#111827;border:1px solid #1f2937;color:#e5e7eb;padding:8px 12px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    input[type="text"], select, input[type="search"]{
      background:#0b162b;color:#e5e7eb;border:1px solid #12315d;border-radius:10px;padding:10px 12px;min-width:220px
    }
    input[type="checkbox"]{transform:scale(1.05)}
    .table{width:100%;border-collapse:collapse;background:#0b1222;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--stroke);font-size:14px;vertical-align:middle}
    .table th{background:#0b152a;text-align:left;color:#9fb2d9}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #1e293b;background:#0a1222;color:#93c5fd}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .drop{border:1.5px dashed #1e3a8a;border-radius:14px;background:linear-gradient(180deg,#09132a,#0a1428);padding:22px;text-align:center;cursor:pointer}
    .drop.drag{background:linear-gradient(180deg,#0b1a3a,#0a162f); border-color:#2563eb}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:12px}
    .cardItem{background:linear-gradient(180deg,#0b1222,#0c1428); border:1px solid #0f213b; border-radius:12px; padding:14px}
    a.dl{display:inline-block;margin-top:8px;background:#0b162b;border:1px solid #12315d;color:#a5f3fc;text-decoration:none;padding:8px 10px;border-radius:8px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:10px">
    <div class="grow">
      <div style="font-size:22px;font-weight:800;letter-spacing:.3px">Panel CSV → SQL Template XLSX</div>
      <div class="muted">Muat naik berbilang CSV • Auto-detect panel • Export templat • Pengurusan panel (tambah/edit/padam) termasuk tukar Kod</div>
    </div>
    <span class="pill mono" id="apiLabel">API</span>
  </div>

  <div class="nav">
    <button class="tab active" data-tab="tab1">Halaman 1 — Panel Register</button>
    <button class="tab" data-tab="tab2">Halaman 2 — Upload & Export</button>
  </div>

  <!-- TAB 1: Panel Register -->
  <section id="tab1" class="card" style="display:block">
    <div class="toolbar">
      <input type="text" id="panelName" placeholder="Nama Panel (cth: AIA HEALTH SERVIS SDN BHD)" class="grow"/>
      <input type="text" id="panelCode" placeholder="Kod Panel (cth: 300-A0001)" />
      <label class="muted" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="panelActive" checked/> Aktif</label>
      <button class="btn" id="btnAdd">Tambah</button>
      <button class="btn2" id="btnRefresh1">Refresh</button>
      <span class="muted" id="panelHint">Tambah panel baharu atau edit/padam pada jadual di bawah.</span>
    </div>

    <div class="row" style="justify-content:space-between;margin:10px 0 6px">
      <div class="muted">Senarai panel dalam <span class="mono">Sheet1</span>.</div>
      <input type="search" id="searchPanel" placeholder="Cari nama/kod…" />
    </div>

    <table class="table" id="panelTable">
      <thead>
        <tr>
          <th style="width:48px">#</th>
          <th>Nama Panel</th>
          <th style="width:180px">Kod Panel</th>
          <th style="width:90px">Aktif</th>
          <th style="width:220px">Tindakan</th>
        </tr>
      </thead>
      <tbody id="panelTBody"></tbody>
    </table>
  </section>

  <!-- TAB 2: Upload & Export -->
  <section id="tab2" class="card" style="display:none">
    <div class="row">
      <div class="grow">
        <div class="muted">API Web App</div>
        <div class="mono" id="apiBaseShow"></div>
      </div>
      <button class="btn2" id="btnRefreshPanels">Refresh Panels</button>
      <button class="btn2" id="btnClean">Clean Now</button>
      <button class="btn" id="btnProcess" disabled>Proses & Eksport XLSX</button>
    </div>

    <div id="panelSummary" class="muted">Memuat panel…</div>

    <label class="drop" id="drop">
      <input id="fileInput" type="file" accept=".csv,text/csv" multiple hidden />
      <div style="font-size:16px;font-weight:700;margin-bottom:6px">Seret & lepas CSV di sini, atau klik untuk pilih</div>
      <div class="muted">Namakan fail ringkas (cth <b>AIA.csv</b>). Sistem cuba padankan <i>Panel</i>. Jika tak tepat, pilih manual.</div>
    </label>

    <table class="table" id="fileTable" style="display:none">
      <thead>
      <tr>
        <th style="width:36px">#</th>
        <th>Fail</th>
        <th style="min-width:240px">Panel (auto / manual)</th>
        <th style="width:120px">Status</th>
        <th style="width:88px"></th>
      </tr>
      </thead>
      <tbody id="fileTBody"></tbody>
    </table>

    <div class="card" id="outWrap" style="display:none;margin-top:12px">
      <div class="row">
        <div class="grow"><b>Hasil Eksport</b></div>
        <span class="pill" id="exportMeta"></span>
      </div>
      <div class="cards" id="cards"></div>
    </div>
  </section>

  <div class="muted" style="margin-top:14px">Pastikan Web App dideploy “Anyone”. Kaedah POST guna <span class="mono">payload=&lt;JSON&gt;</span> (tiada preflight/CORS).</div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API_BASE = "https://script.google.com/macros/s/AKfycbwcoL2BuH__0BmXQfK3C2D_krslAb9FKqn1WBGlYOyI1G_DlULF-kVjTzxKc4AM-YI/exec";

/* ============== Helper: simple POST (no CORS preflight) ============== */
function apiPost(payload){
  const body = new URLSearchParams({ payload: JSON.stringify(payload) });
  return fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body
  }).then(r=>r.json());
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}
function byId(id){return document.getElementById(id)}
function setBusy(b){[els.btnAdd,els.btnRefresh1,els.btnProcess,els.btnRefreshPanels,els.btnClean].forEach(x=>x&&(x.disabled=b));}

/* ===================== Elements ===================== */
const els = {
  apiLabel: byId('apiLabel'),
  apiBaseShow: byId('apiBaseShow'),
  // nav
  tabBtns: Array.from(document.querySelectorAll('.tab')),
  tab1: byId('tab1'),
  tab2: byId('tab2'),
  // tab1
  panelName: byId('panelName'),
  panelCode: byId('panelCode'),
  panelActive: byId('panelActive'),
  btnAdd: byId('btnAdd'),
  btnRefresh1: byId('btnRefresh1'),
  panelTBody: byId('panelTBody'),
  searchPanel: byId('searchPanel'),
  // tab2
  panelSummary: byId('panelSummary'),
  drop: byId('drop'),
  fileInput: byId('fileInput'),
  fileTable: byId('fileTable'),
  fileTBody: byId('fileTBody'),
  btnProcess: byId('btnProcess'),
  btnRefreshPanels: byId('btnRefreshPanels'),
  btnClean: byId('btnClean'),
  outWrap: byId('outWrap'),
  exportMeta: byId('exportMeta'),
  cards: byId('cards')
};
els.apiLabel.textContent = 'API: ' + (new URL(API_BASE)).host;
els.apiBaseShow.textContent = API_BASE;

/* ===================== NAV ===================== */
els.tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    els.tabBtns.forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.getAttribute('data-tab');
    els.tab1.style.display = (id==='tab1')?'block':'none';
    els.tab2.style.display = (id==='tab2')?'block':'none';
  });
});

/* ===================== DATA (Panels) ===================== */
let PANELS = [];         // {PanelName, PanelCode, Active}
let PANEL_OPTIONS_HTML = '';

async function loadPanels(){
  const res = await apiPost({action:'listPanels'});
  if(!res || !res.ok){ console.error(res); return; }
  PANELS = (res.panels||[]).filter(p=>p.PanelName); // semua, biar toggle aktif ikut nilai
  buildPanelOptions();
  renderPanelTable();
  // tab2 summary (kira aktif)
  const activeCount = PANELS.filter(p=>p.Active!==false).length;
  els.panelSummary.textContent = `Jumlah panel aktif: ${activeCount}`;
}
function buildPanelOptions(){
  const actives = PANELS.filter(p=>p.Active!==false);
  PANEL_OPTIONS_HTML = `<option value="">— pilih panel —</option>` +
    actives.map(p => `<option value="${escapeHtml(p.PanelCode)}">${escapeHtml(p.PanelName)} — ${escapeHtml(p.PanelCode)}</option>`).join('');
}

/* ===================== TAB 1 – CRUD Panel ===================== */
function renderPanelTable(){
  const q = els.searchPanel.value.trim().toLowerCase();
  const rows = PANELS
    .filter(p => !q || (String(p.PanelName).toLowerCase().includes(q) || String(p.PanelCode).toLowerCase().includes(q)))
    .map((p,i)=> rowPanel(p,i));
  els.panelTBody.innerHTML = '';
  rows.forEach(tr => els.panelTBody.appendChild(tr));
}
function rowPanel(p, idx){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${idx+1}</td>
    <td><span class="mono">${escapeHtml(p.PanelName)}</span></td>
    <td><span class="mono">${escapeHtml(p.PanelCode)}</span></td>
    <td>${p.Active!==false?'<span class="ok">Ya</span>':'<span class="err">Tidak</span>'}</td>
    <td>
      <button class="btn3">Edit</button>
      <button class="btn3" style="margin-left:6px">Padam</button>
    </td>`;
  const btnEdit = tr.children[4].children[0];
  const btnDel  = tr.children[4].children[1];

  btnEdit.addEventListener('click', ()=>{
    // editable row — boleh ubah Nama, Kod, Aktif
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><input type="text" value="${escapeHtml(p.PanelName)}" style="width:100%"/></td>
      <td><input type="text" value="${escapeHtml(p.PanelCode)}" style="width:160px"/></td>
      <td><label style="display:flex;gap:6px;align-items:center"><input type="checkbox" ${p.Active!==false?'checked':''}/> Aktif</label></td>
      <td>
        <button class="btn3">Simpan</button>
        <button class="btn3" style="margin-left:6px">Batal</button>
      </td>`;
    const inputName = tr.children[1].querySelector('input');
    const inputCode = tr.children[2].querySelector('input');
    const chkActive = tr.children[3].querySelector('input[type="checkbox"]');
    const bSave = tr.children[4].children[0];
    const bCancel = tr.children[4].children[1];

    bSave.addEventListener('click', async ()=>{
      const newName = inputName.value.trim();
      const newCode = inputCode.value.trim();
      if(!newName || !newCode){ alert('Nama & Kod wajib.'); return; }
      setBusy(true);
      try{
        if (newCode !== p.PanelCode) {
          // 1) tukar kod (aksi baru di backend)
          const r1 = await apiPost({action:'renamePanelCode', oldCode:p.PanelCode, newCode:newCode});
          if(!r1 || !r1.ok){ throw new Error(r1 && r1.error || 'Gagal tukar kod'); }
          // 2) kemaskini nama/aktif (guna kod baharu)
          const r2 = await apiPost({action:'updatePanel', panelCode:newCode, newName:newName, active:chkActive.checked});
          if(!r2 || !r2.ok){ throw new Error(r2 && r2.error || 'Gagal kemaskini panel'); }
        } else {
          // kod tak berubah → hanya update nama/aktif
          const r = await apiPost({action:'updatePanel', panelCode:p.PanelCode, newName:newName, active:chkActive.checked});
          if(!r || !r.ok){ throw new Error(r && r.error || 'Gagal kemaskini panel'); }
        }
        await refreshPanelsBoth();
      }catch(e){
        alert(String(e.message||e));
      }finally{
        setBusy(false);
      }
    });
    bCancel.addEventListener('click', renderPanelTable);
  });

  btnDel.addEventListener('click', async ()=>{
    if(!confirm('Padam panel ini?')) return;
    setBusy(true);
    const res = await apiPost({action:'deletePanel', panelCode:p.PanelCode});
    setBusy(false);
    if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal padam panel'); return; }
    await refreshPanelsBoth();
  });

  return tr;
}

els.btnAdd.addEventListener('click', async ()=>{
  const name = els.panelName.value.trim();
  const code = els.panelCode.value.trim();
  const active = els.panelActive.checked;
  if(!name || !code){ alert('Isi Nama Panel dan Kod Panel.'); return; }
  setBusy(true);
  const res = await apiPost({action:'createPanel', panelName:name, panelCode:code, active});
  setBusy(false);
  if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal tambah panel'); return; }
  els.panelName.value=''; els.panelCode.value='';
  await refreshPanelsBoth();
});
els.btnRefresh1.addEventListener('click', refreshPanelsBoth);
els.searchPanel.addEventListener('input', renderPanelTable);

async function refreshPanelsBoth(){
  const res = await apiPost({action:'listPanels'});
  if(res && res.ok){
    PANELS = (res.panels||[]).filter(p=>p.PanelName);
    buildPanelOptions();
    renderPanelTable();
    const activeCount = PANELS.filter(p=>p.Active!==false).length;
    els.panelSummary.textContent = `Jumlah panel aktif: ${activeCount}`;
  }
}

/* ===================== TAB 2 – Upload & Export ===================== */
let filesQueue = []; // {id,name,text,panelCode,auto,status}

function buildPanelKeys(){
  const actives = PANELS.filter(p=>p.Active!==false);
  return actives.map(p=>{
    const code = String(p.PanelCode||'').toUpperCase();
    const name = String(p.PanelName||'').toUpperCase();
    const clean = name.replace(/[^A-Z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
    const words = clean.split(' ').filter(w=>w.length>=3);
    const acronym = (name.match(/\b[A-Z]{2,}\b/g)||[]).join(' ');
    const keys = new Set([code, ...words]);
    if(acronym) acronym.split(' ').forEach(k=>keys.add(k));
    if(words.length) keys.add(words[0]);
    return {code, name, keys:[...keys]};
  });
}
function detectPanelFromFilename(fname){
  const stem = fname.split('/').pop().replace(/\.[^.]+$/,'').toUpperCase();
  const cands = buildPanelKeys();
  let best=null;
  for(const c of cands){
    for(const k of c.keys){
      if(!k) continue;
      if(stem.includes(k)){ const score=k.length; if(!best||score>best.score) best={code:c.code,score}; }
    }
  }
  return best?best.code:'';
}

function addFiles(list){
  const arr = Array.from(list||[]);
  if(!arr.length) return;
  els.fileTable.style.display = 'table';
  arr.forEach(f=>{
    if(!/\.csv$/i.test(f.name)) return;
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random();
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = String(reader.result||'');
      const code = detectPanelFromFilename(f.name);
      filesQueue.push({id,name:f.name,text, panelCode:code||'', auto:!!code, status:'Ready'});
      renderQueue();
    };
    reader.readAsText(f);
  });
}
function renderQueue(){
  els.fileTBody.innerHTML = '';
  filesQueue.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><div class="mono">${escapeHtml(it.name)}</div><div class="muted" style="font-size:12px">${it.auto?'auto':'manual'}${it.panelCode?` · ${escapeHtml(it.panelCode)}`:''}</div></td>
      <td></td>
      <td><span class="${it.status==='OK'?'ok':(it.status==='Ready'?'muted':'err')}">${escapeHtml(it.status)}</span></td>
      <td><button class="btn3">Buang</button></td>`;
    const tdSel = tr.children[2];
    const sel = document.createElement('select');
    sel.innerHTML = PANEL_OPTIONS_HTML;
    sel.value = it.panelCode || '';
    sel.onchange = e=>{ it.panelCode = e.target.value; it.auto=false; renderQueue(); };
    tdSel.appendChild(sel);
    tr.children[4].children[0].onclick = ()=>{ filesQueue = filesQueue.filter(x=>x.id!==it.id); renderQueue(); };
    els.fileTBody.appendChild(tr);
  });
  els.btnProcess.disabled = !filesQueue.some(x=>x.panelCode);
}

async function processAll(){
  const missing = filesQueue.filter(x=>!x.panelCode);
  if(missing.length){ alert('Sila pilih Panel untuk semua fail.'); return; }
  setBusy(true);
  const payload = { action:'processCsvFiles', files: filesQueue.map(x=>({name:x.name, content:x.text, panelCode:x.panelCode})) };
  let res;
  try{ res = await apiPost(payload); }catch(e){ setBusy(false); alert('Ralat rangkaian/API.'); return; }
  setBusy(false);
  if(!res || !res.ok){ console.error(res); alert('Proses gagal: ' + (res && res.error || 'Unknown')); return; }
  (res.files||[]).forEach(f=>{ filesQueue.forEach(q=>{ if(q.panelCode===f.panelCode) q.status='OK'; }); });
  renderQueue();
  renderResults(res.files||[]);
}
function renderResults(files){
  els.outWrap.style.display = 'block';
  els.cards.innerHTML = '';
  els.exportMeta.textContent = files.length ? `${files.length} fail dijana` : 'Tiada fail dijana';
  files.forEach(f=>{
    const div = document.createElement('div'); div.className='cardItem';
    div.innerHTML = `
      <div style="font-weight:700">${escapeHtml(f.filename)}</div>
      <div class="muted" style="font-size:13px;margin-top:4px">
        Panel: <b>${escapeHtml(f.panelName || f.panelCode)}</b><br/>
        Baris: ${f.rows} · Jumlah (batch): ${Number(f.amountSum||0).toLocaleString('en-MY')}
      </div>
      <a class="dl" target="_blank" rel="noopener" href="${escapeHtml(f.downloadUrl)}">Muat turun</a>`;
    els.cards.appendChild(div);
  });
}

/* ===================== Clean Now ===================== */
async function cleanNow(){
  if(!confirm('Padam SEMUA eksport (.xlsx) dalam folder eksport? (Ke Trash)')) return;
  setBusy(true);
  let res; try{
    res = await apiPost({action:'cleanupExportsNow', includeRoot:true});
  }catch(e){ setBusy(false); alert('Ralat rangkaian/API.'); return; }
  setBusy(false);
  alert('Cleanup siap. Dipadam: ' + (res && res.deleted || 0));
}

/* ===================== Events & Init ===================== */
// Tab
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.tab;
    els.tab1.style.display = id==='tab1' ? 'block':'none';
    els.tab2.style.display = id==='tab2' ? 'block':'none';
  });
});

// Tab1 CRUD
els.btnAdd.addEventListener('click', async ()=>{
  const name = els.panelName.value.trim();
  const code = els.panelCode.value.trim();
  const active = els.panelActive.checked;
  if(!name || !code){ alert('Isi Nama Panel dan Kod Panel.'); return; }
  setBusy(true);
  const res = await apiPost({action:'createPanel', panelName:name, panelCode:code, active});
  setBusy(false);
  if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal tambah panel'); return; }
  els.panelName.value=''; els.panelCode.value='';
  await refreshPanelsBoth();
});
els.btnRefresh1.addEventListener('click', refreshPanelsBoth);
els.searchPanel.addEventListener('input', renderPanelTable);

// Tab2 actions
els.btnRefreshPanels.addEventListener('click', refreshPanelsBoth);
els.btnProcess.addEventListener('click', processAll);
els.btnClean.addEventListener('click', cleanNow);

// Upload widgets
els.drop.addEventListener('click', ()=> els.fileInput.click());
els.fileInput.addEventListener('change', e=> addFiles(e.target.files));
['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag');}));
els.drop.addEventListener('drop', e=>{ const dt=e.dataTransfer; if(dt&&dt.files) addFiles(dt.files); });

// Boot
loadPanels();
</script>
</body>
</html>
