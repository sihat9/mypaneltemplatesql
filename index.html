<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel CSV → SQL Template XLSX</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22c55e; --brand2:#10b981; --warn:#f59e0b; --err:#ef4444; --ok:#22c55e;
      --stroke:#1f2937; --chip:#0b1222; --chip2:#0e182b;
    }
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1020,#0b0f1a);}
    *{box-sizing:border-box;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px;color:var(--text);}
    .hero{display:flex;gap:18px;align-items:center;margin-bottom:18px}
    .badge{font-size:12px;color:#a7f3d0;background:#064e3b;border:1px solid #065f46;border-radius:999px;padding:4px 10px}
    .card{background:linear-gradient(180deg,#0b1222,#0c1428); border:1px solid #0f213b; border-radius:14px; padding:18px; box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > * {flex:0 0 auto}
    .grow{flex:1 1 auto}
    .btn{background:linear-gradient(180deg,#16a34a,#22c55e); border:1px solid #22c55e; color:#052e16; font-weight:700; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn2{background:#0b162b;border:1px solid #12315d;color:#dbeafe;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn3{background:#111827;border:1px solid #1f2937;color:#e5e7eb;padding:10px 12px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:14px}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #1e293b;background:#0a1222;color:#93c5fd}
    .ok{color:#10b981}.err{color:#ef4444}
    .grid{display:grid;gap:10px}
    .drop{border:1.5px dashed #1e3a8a;border-radius:14px;background:linear-gradient(180deg,#09132a,#0a1428);padding:22px;text-align:center;cursor:pointer}
    .drop.drag{background:linear-gradient(180deg,#0b1a3a,#0a162f); border-color:#2563eb}
    .files{width:100%;border-collapse:collapse;background:#0b1222;border:1px solid #14223d;border-radius:10px;overflow:hidden}
    .files th,.files td{padding:10px 12px;border-bottom:1px solid #0f213b;font-size:14px}
    .files th{background:#0b152a;text-align:left;color:#9fb2d9}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    select, input[type="text"]{
      background:#0b162b;color:#e5e7eb;border:1px solid #12315d;border-radius:8px;padding:8px 10px;min-width:220px
    }
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .cardItem{background:linear-gradient(180deg,#0b1222,#0c1428); border:1px solid #0f213b; border-radius:12px; padding:14px}
    a.dl{display:inline-block;margin-top:8px;background:#0b162b;border:1px solid #12315d;color:#a5f3fc;text-decoration:none;padding:8px 10px;border-radius:8px}
    .footer{margin-top:24px;color:#9ca3af;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="#a5f3fc" stroke-width="2" stroke-linecap="round"/></svg>
      <div>
        <div style="font-size:20px;font-weight:800;letter-spacing:.3px">Panel CSV → SQL Template XLSX</div>
        <div class="muted">Muat naik berbilang CSV • Auto-detect panel daripada nama fail • Export ikut had baris & jumlah • Nama fail pintar</div>
      </div>
      <span class="badge">vUI 2.0</span>
    </div>

    <div class="card grid" style="gap:14px">
      <div class="row">
        <div class="grow">
          <div class="muted">API</div>
          <div class="mono" id="apiBaseShow"></div>
        </div>
        <button class="btn3" id="btnRefreshPanels">Refresh Panels</button>
        <button class="btn2" id="btnClean">Clean Now</button>
        <button class="btn" id="btnProcess" disabled>Proses & Eksport XLSX</button>
      </div>

      <div id="panelSummary" class="muted">Memuat panel…</div>

      <label class="drop" id="drop">
        <input id="fileInput" type="file" accept=".csv,text/csv" multiple hidden />
        <div style="font-size:16px;font-weight:700;margin-bottom:6px">Seret & lepas CSV di sini, atau klik untuk pilih</div>
        <div class="muted">Namakan fail ringkas (cth <b>AIA.csv</b>). Sistem cuba padankan <i>PanelName</i>. Jika tidak tepat, pilih manual.</div>
      </label>

      <table class="files" id="fileTable" style="display:none">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th>Fail</th>
            <th style="min-width:220px">Panel (auto / manual)</th>
            <th style="width:120px">Status</th>
            <th style="width:80px"></th>
          </tr>
        </thead>
        <tbody id="fileTBody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:16px;display:none" id="outWrap">
      <div class="row">
        <div class="grow"><b>Hasil Eksport</b></div>
        <span class="pill" id="exportMeta"></span>
      </div>
      <div class="cards" id="cards"></div>
    </div>

    <div class="footer">Tip: jika panel tak dikesan dari nama fail, pilih manual di dropdown. Sistem akan gunakan <span class="mono">PanelCode</span> sebenar dari Sheet1.</div>
  </div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbwcoL2BuH__0BmXQfK3C2D_krslAb9FKqn1WBGlYOyI1G_DlULF-kVjTzxKc4AM-YI/exec";

const els = {
  apiBaseShow: document.getElementById('apiBaseShow'),
  panelSummary: document.getElementById('panelSummary'),
  fileInput: document.getElementById('fileInput'),
  drop: document.getElementById('drop'),
  tbl: document.getElementById('fileTable'),
  tbody: document.getElementById('fileTBody'),
  btnProcess: document.getElementById('btnProcess'),
  btnRefreshPanels: document.getElementById('btnRefreshPanels'),
  btnClean: document.getElementById('btnClean'),
  outWrap: document.getElementById('outWrap'),
  cards: document.getElementById('cards'),
  exportMeta: document.getElementById('exportMeta')
};

els.apiBaseShow.textContent = API_BASE;

let PANELS = [];        // {PanelName, PanelCode, Active}
let PANEL_MAP = new Map(); // code -> name
let PANEL_OPTIONS_HTML = '';
let filesQueue = [];    // {id,name,contentText,panelCode,auto, status}

function apiPost(payload){
  return fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).then(r=>r.json());
}

async function refreshPanels(){
  els.panelSummary.textContent = 'Memuat panel…';
  const res = await apiPost({action:'listPanels'});
  if(!res || !res.ok){ els.panelSummary.innerHTML = `<span class="err">Gagal muat panel.</span>`; return; }
  PANELS = (res.panels||[]).filter(p=>p.Active!==false);
  PANEL_MAP.clear();
  PANELS.forEach(p=>PANEL_MAP.set(String(p.PanelCode).toUpperCase(), String(p.PanelName||'').trim()));

  // build dropdown options
  PANEL_OPTIONS_HTML = `<option value="">— pilih panel —</option>` +
    PANELS.map(p => `<option value="${escapeHtml(p.PanelCode)}">${escapeHtml(p.PanelName)} — ${escapeHtml(p.PanelCode)}</option>`).join('');

  els.panelSummary.innerHTML = `Jumlah panel aktif: <b>${PANELS.length}</b>`;
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}

// ======== Auto detect panel from short filename ========
function buildPanelKeys(){
  // produce keys for fuzzy matching: name words, acronym, code
  return PANELS.map(p=>{
    const code = String(p.PanelCode||'').toUpperCase();
    const name = String(p.PanelName||'').toUpperCase();
    const clean = name.replace(/[^A-Z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
    const words = clean.split(' ').filter(w=>w.length>=3);
    const acronym = (name.match(/\b[A-Z]{2,}\b/g)||[]).join(' ');
    const keys = new Set([code, ...words]);
    if(acronym) acronym.split(' ').forEach(k=>keys.add(k));
    // also add first token (often acronym/company short)
    if(words.length) keys.add(words[0]);
    return {code, name, keys: Array.from(keys)};
  });
}
function detectPanelFromFilename(fname){
  const base = fname.split('/').pop();
  const stem = base.replace(/\.[^.]+$/,'').toUpperCase(); // remove extension
  const candidates = buildPanelKeys();
  // score: longest key found within filename
  let best = null;
  for(const c of candidates){
    for(const k of c.keys){
      if(!k) continue;
      if(stem.includes(k)){
        const score = k.length; // prefer longer
        if(!best || score > best.score){
          best = {code:c.code, score, key:k};
        }
      }
    }
  }
  return best ? best.code : '';
}

// ======== UI: file queue ========
function addFiles(fileList){
  const arr = Array.from(fileList||[]);
  if(!arr.length) return;
  els.tbl.style.display = 'table';
  for(const f of arr){
    if(!/\.csv$/i.test(f.name)){ continue; }
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random();
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result || '';
      let panelCode = detectPanelFromFilename(f.name);
      let auto = !!panelCode;
      filesQueue.push({id, name:f.name, contentText:String(text), panelCode, auto, status:'Ready'});
      renderQueue();
    };
    reader.readAsText(f);
  }
}

function renderQueue(){
  els.tbody.innerHTML = '';
  filesQueue.forEach((it,idx)=>{
    const tr = document.createElement('tr');

    const tdIdx = document.createElement('td'); tdIdx.textContent = String(idx+1); tr.appendChild(tdIdx);

    const tdName = document.createElement('td');
    tdName.innerHTML = `<div class="mono">${escapeHtml(it.name)}</div><div class="muted" style="font-size:12px">${it.auto?'<span class="ok">auto</span>':'manual'}${it.panelCode?` · ${escapeHtml(it.panelCode)}`:''}</div>`;
    tr.appendChild(tdName);

    const tdSel = document.createElement('td');
    const sel = document.createElement('select');
    sel.innerHTML = PANEL_OPTIONS_HTML;
    sel.value = it.panelCode || '';
    sel.onchange = e => { it.panelCode = e.target.value; it.auto = false; renderQueue(); };
    tdSel.appendChild(sel);
    tr.appendChild(tdSel);

    const tdStatus = document.createElement('td');
    tdStatus.innerHTML = `<span class="${it.status==='Ready'?'muted':(it.status==='OK'?'ok':'err')}">${escapeHtml(it.status)}</span>`;
    tr.appendChild(tdStatus);

    const tdAct = document.createElement('td');
    const rm = document.createElement('button'); rm.className='btn3'; rm.textContent='Buang';
    rm.onclick = () => { filesQueue = filesQueue.filter(x=>x.id!==it.id); renderQueue(); };
    tdAct.appendChild(rm);
    tr.appendChild(tdAct);

    els.tbody.appendChild(tr);
  });

  // enable Process if at least one item with panelCode chosen
  const can = filesQueue.some(x=>x.panelCode);
  els.btnProcess.disabled = !can;
}

async function processAll(){
  // validate: all files must have panelCode
  const missing = filesQueue.filter(x=>!x.panelCode);
  if(missing.length){
    alert('Sila pilih Panel untuk semua fail yang belum dipadankan.');
    return;
  }
  setBusy(true);
  // build payload for backend
  const payload = {
    action: 'processCsvFiles',
    files: filesQueue.map(x=>({
      name: x.name,
      content: x.contentText,
      panelCode: x.panelCode
    }))
  };
  let res;
  try{
    res = await apiPost(payload);
  }catch(e){
    setBusy(false);
    alert('Ralat rangkaian/API.');
    return;
  }
  setBusy(false);

  if(!res || !res.ok){
    console.error(res);
    alert('Proses gagal: ' + (res && res.error || 'Unknown error'));
    return;
  }

  // mark statuses
  (res.files||[]).forEach(f=>{
    filesQueue.forEach(q=>{
      // kasar: padan melalui panel atau ignore
      if(q.panelCode === f.panelCode) q.status = 'OK';
    });
  });

  // render cards
  renderQueue();
  renderResults(res.files||[]);
}

function renderResults(files){
  els.outWrap.style.display = 'block';
  els.cards.innerHTML = '';
  els.exportMeta.textContent = files.length ? `${files.length} fail dijana` : 'Tiada fail dijana';
  files.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'cardItem';
    div.innerHTML = `
      <div style="font-weight:700">${escapeHtml(f.filename)}</div>
      <div class="muted" style="font-size:13px;margin-top:4px">
        Panel: <b>${escapeHtml(f.panelName || f.panelCode)}</b><br/>
        Baris: ${f.rows} · Jumlah (batch): ${Number(f.amountSum||0).toLocaleString('en-MY')}
      </div>
      <a class="dl" target="_blank" rel="noopener" href="${escapeHtml(f.downloadUrl)}">Muat turun</a>
    `;
    els.cards.appendChild(div);
  });
}

function setBusy(b){
  els.btnProcess.disabled = b;
  els.btnRefreshPanels.disabled = b;
  els.btnClean.disabled = b;
}

// Clean Now — panggil endpoint buang semua .xlsx dalam folder eksport (dan root “EXPORT-*.xlsx”)
async function cleanNow(){
  if(!confirm('Padam SEMUA fail eksport (.xlsx) dalam folder eksport? (Akan ke Trash)')) return;
  setBusy(true);
  let res;
  try{
    res = await apiPost({action:'cleanupExportsNow', includeRoot:true});
  }catch(e){
    setBusy(false); alert('Ralat rangkaian/API semasa pembersihan.'); return;
  }
  setBusy(false);
  alert('Cleanup siap. Dipadam: ' + (res && res.deleted || 0));
}

// ======== init & events ========
els.btnProcess.addEventListener('click', processAll);
els.btnClean.addEventListener('click', cleanNow);
els.btnRefreshPanels.addEventListener('click', refreshPanels);

els.drop.addEventListener('click', ()=> els.fileInput.click());
els.fileInput.addEventListener('change', e=> addFiles(e.target.files));

['dragenter','dragover'].forEach(ev=>{
  els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag'); });
});
['dragleave','drop'].forEach(ev=>{
  els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag'); });
});
els.drop.addEventListener('drop', e=>{
  const dt = e.dataTransfer;
  if(dt && dt.files) addFiles(dt.files);
});

// boot
refreshPanels();
</script>
</body>
</html>
