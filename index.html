<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sistem Kak Ros</title>
  <style>
    /* ========= MODERN THEME ========= */
    :root {
      /* Color Palette - Modern & Professional */
      --bg: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --paper: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --stroke: #e2e8f0;
      --stroke-strong: #cbd5e1;
      --brand: #3b82f6;
      --brand-light: #60a5fa;
      --brand-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      --brand-gradient-light: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      --ok: #10b981;
      --err: #ef4444;
      --warn: #f59e0b;
      --chip: #e0f2fe;
      --chip-text: #0c4a6e;
      --soft: #f8fafc;
      --soft-2: #f1f5f9;
      
      /* Shadows - Modern depth */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius: 10px;
      --radius-md: 12px;
      --radius-lg: 16px;
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
    }

    /* ========= BASE STYLES ========= */
    html, body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 15.5px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }
    
    * {
      box-sizing: border-box;
    }

    /* ========= LAYOUT ========= */
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    .topbar {
      display: flex;
      gap: var(--space-md);
      align-items: center;
      margin-bottom: var(--space-lg);
      padding: var(--space-md) 0;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      background: var(--brand-gradient);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 18px;
    }

    .title {
      font-weight: 800;
      font-size: 26px;
      letter-spacing: -0.025em;
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: var(--space-xs);
    }

    .subtitle {
      color: var(--muted);
      font-size: 15px;
      font-weight: 500;
    }

    .tabs {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
      background: var(--paper);
      padding: var(--space-sm);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .tab {
      padding: var(--space-md) var(--space-lg);
      border: none;
      border-radius: var(--radius-md);
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      flex: 1;
      text-align: center;
    }

    .tab.active {
      background: var(--brand-gradient);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .tab:hover:not(.active) {
      background: var(--soft);
    }

    .card {
      background: var(--paper);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow);
      margin-bottom: var(--space-lg);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .card-title {
      font-weight: 700;
      font-size: 18px;
      color: var(--ink);
    }

    .row {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      align-items: center;
    }

    .grow {
      flex: 1 1 auto;
    }

    /* ========= INPUTS & BUTTONS ========= */
    input[type="text"], input[type="search"], select {
      background: var(--soft);
      border: 1px solid var(--stroke-strong);
      border-radius: var(--radius);
      padding: 12px 14px;
      min-width: 220px;
      outline: none;
      transition: all 0.2s ease;
      font-size: 15px;
      font-family: inherit;
    }

    input[type="text"]:focus, input[type="search"]:focus, select:focus {
      border-color: var(--brand-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      background: white;
    }

    input[type="checkbox"] {
      transform: scale(1.1);
      accent-color: var(--brand);
    }

    .btn {
      background: var(--brand-gradient);
      border: none;
      color: white;
      font-weight: 700;
      padding: 12px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn2 {
      background: var(--soft);
      border: 1px solid var(--stroke-strong);
      color: var(--ink);
      padding: 12px 18px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn2:hover {
      background: #f1f5f9;
      border-color: var(--brand-light);
    }

    .btn3 {
      background: var(--soft);
      border: 1px solid var(--stroke-strong);
      color: var(--ink);
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn3:hover {
      background: #f1f5f9;
      border-color: var(--brand-light);
    }

    .muted {
      color: var(--muted);
      font-size: 14.5px;
    }

    .mono {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
      font-size: 14.5px;
    }

    /* ========= TABLE ========= */
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--paper);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .table th, .table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      font-size: 15px;
      vertical-align: middle;
    }

    .table th {
      background: #f8fafc;
      text-align: left;
      color: #111827;
      font-weight: 700;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .ok {
      color: var(--ok);
      font-weight: 700;
    }

    .err {
      color: var(--err);
      font-weight: 700;
    }

    /* ========= DROPZONE ========= */
    .drop {
      border: 2px dashed #93c5fd;
      border-radius: var(--radius-lg);
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .drop:hover, .drop.drag {
      background: linear-gradient(180deg, #f0f7ff, #eaf2ff);
      border-color: var(--brand-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ========= RESULT CARDS ========= */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--space-md);
    }

    .cardItem {
      background: var(--paper);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .cardItem:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    a.dl {
      display: inline-block;
      margin-top: var(--space-sm);
      background: var(--chip);
      border: 1px solid #c7d2fe;
      color: var(--chip-text);
      text-decoration: none;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-weight: 700;
      transition: all 0.2s ease;
    }

    a.dl:hover {
      background: #dbeafe;
      transform: translateY(-2px);
    }

    /* ========= UPGRADED LOADER ========= */
    .progress {
      position: fixed;
      left: 0;
      top: 0;
      height: 3px;
      width: 100%;
      background: transparent;
      z-index: 9999;
      pointer-events: none;
    }

    .progress .bar {
      position: absolute;
      height: 3px;
      background: var(--brand-gradient);
      width: 30%;
      border-radius: 3px;
      animation: flow 1.2s infinite;
    }

    @keyframes flow {
      0% { left: -30%; }
      50% { left: 50%; }
      100% { left: 100%; }
    }

    .skeleton {
      position: relative;
      overflow: hidden;
      background: var(--soft-2);
      border-radius: var(--radius-sm);
      height: 16px;
    }

    .skeleton::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.06), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }

    .hidden {
      display: none;
    }

    label.lb {
      display: block;
      margin: 0 0 var(--space-sm) 2px;
      color: var(--ink);
      font-weight: 700;
      font-size: 14px;
    }

    /* ========= RESPONSIVE ========= */
    @media (max-width: 768px) {
      .wrap {
        padding: var(--space-sm);
      }
      
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm);
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      input[type="text"], input[type="search"], select {
        min-width: 100%;
      }
      
      .cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="progress hidden" id="progress"><div class="bar"></div></div>

  <div class="wrap">
    <div class="topbar">
      <div class="logo">KR</div>
      <div class="grow">
        <div class="title">Panel CSV → SQL Template XLSX</div>
        <div class="subtitle">Pengurusan panel (tambah • edit • padam • eksport ikut templat)</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="tab1">Daftar Panel</button>
      <button class="tab" data-tab="tab2">Upload & Export</button>
    </div>

    <!-- TAB 1: Panel Register -->
    <section id="tab1" class="card">
      <div class="card-header">
        <div class="card-title">Daftar Panel</div>
      </div>
      
      <div class="row" style="gap:12px;align-items:flex-end">
        <div class="grow">
          <label class="lb">Nama Panel</label>
          <input type="text" id="panelName" placeholder="cth: AIA HEALTH SERVIS SDN BHD" class="grow"/>
        </div>
        <div>
          <label class="lb">Kod Panel</label>
          <input type="text" id="panelCode" placeholder="cth: 300-A0001"/>
        </div>
        <label class="muted" style="display:flex;gap:8px;align-items:center;margin-bottom:2px"><input type="checkbox" id="panelActive" checked/> Aktif</label>
        <button class="btn" id="btnAdd">Tambah</button>
        <button class="btn2" id="btnRefresh1">Refresh</button>
      </div>

      <div class="row" style="justify-content:space-between;margin:16px 0 8px">
        <div class="muted">Senarai panel yang di <span class="mono">disimpan</span>.</div>
        <input type="search" id="searchPanel" placeholder="Cari nama atau kod…"/>
      </div>

      <table class="table" id="panelTable">
        <thead>
          <tr>
            <th style="width:54px">#</th>
            <th>Nama Panel</th>
            <th style="width:190px">Kod Panel</th>
            <th style="width:90px">Aktif</th>
            <th style="width:260px">Tindakan</th>
          </tr>
        </thead>
        <tbody id="panelTBody">
          <!-- skeleton while loading -->
          <tr class="skrow"><td><div class="skeleton" style="width:26px"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton" style="width:120px"></div></td><td><div class="skeleton" style="width:56px"></div></td><td><div class="skeleton" style="width:180px"></div></td></tr>
          <tr class="skrow"><td><div class="skeleton" style="width:26px"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton" style="width:120px"></div></td><td><div class="skeleton" style="width:56px"></div></td><td><div class="skeleton" style="width:180px"></div></td></tr>
        </tbody>
      </table>
    </section>

    <!-- TAB 2: Upload & Export -->
    <section id="tab2" class="card" style="display:none">
      <div class="card-header">
        <div class="card-title">Upload & Export</div>
      </div>
      
      <div class="row" style="align-items:flex-start">
        <div class="grow">
          <div class="muted" style="margin-bottom:6px">Muat naik CSV panel (boleh banyak fail sekali gus)</div>
          <label class="drop" id="drop">
            <input id="fileInput" type="file" accept=".csv,text/csv" multiple hidden />
            <div style="font-size:16px;font-weight:800;margin-bottom:6px">Seret & lepas CSV di sini, atau klik untuk pilih</div>
            <div class="muted">Namakan fail ringkas (cth <b>AIA.csv</b>). Sistem cuba padankan panel; jika tidak tepat, pilih manual.</div>
          </label>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn2" id="btnRefreshPanels">Refresh Panels</button>
          <button class="btn2" id="btnClean">Clean Now</button>
          <button class="btn"  id="btnProcess" disabled>Proses & Eksport XLSX</button>
        </div>
      </div>

      <div id="panelSummary" class="muted" style="margin-top:10px">Memuat panel…</div>

      <table class="table" id="fileTable" style="display:none;margin-top:14px">
        <thead>
        <tr>
          <th style="width:44px">#</th>
          <th>Fail</th>
          <th style="min-width:280px">Panel (auto / manual)</th>
          <th style="width:130px">Status</th>
          <th style="width:96px"></th>
        </tr>
        </thead>
        <tbody id="fileTBody"></tbody>
      </table>

      <div class="card" id="outWrap" style="display:none;margin-top:16px;background:#fbfdff">
        <div class="card-header">
          <div class="card-title">Hasil Eksport</div>
          <span class="muted" id="exportMeta">Tiada fail</span>
        </div>
        <div class="cards" id="cards"></div>
      </div>
    </section>
  </div>

<script>
/* ===================== CONFIG ===================== */
/* Disembunyikan di UI. Pastikan URL ini kekal betul. */
const API_BASE = "https://script.google.com/macros/s/AKfycbwcoL2BuH__0BmXQfK3C2D_krslAb9FKqn1WBGlYOyI1G_DlULF-kVjTzxKc4AM-YI/exec";

/* ============== Helper: POST tanpa CORS preflight ============== */
function apiPost(payload){
  const body = new URLSearchParams({ payload: JSON.stringify(payload) });
  return fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body
  }).then(r=>r.json());
}
const $ = id => document.getElementById(id);
const els = {
  // tabs
  tabBtns: Array.from(document.querySelectorAll('.tab')), tab1: $('tab1'), tab2: $('tab2'),
  // tab1
  panelName: $('panelName'), panelCode: $('panelCode'), panelActive: $('panelActive'),
  btnAdd: $('btnAdd'), btnRefresh1: $('btnRefresh1'), panelTBody: $('panelTBody'), searchPanel: $('searchPanel'),
  // tab2
  panelSummary: $('panelSummary'), drop: $('drop'), fileInput: $('fileInput'), fileTable: $('fileTable'),
  fileTBody: $('fileTBody'), btnProcess: $('btnProcess'), btnRefreshPanels: $('btnRefreshPanels'),
  btnClean: $('btnClean'), outWrap: $('outWrap'), exportMeta: $('exportMeta'), cards: $('cards'),
  // loader
  progress: $('progress')
};

/* ===================== LOADER ===================== */
let loadingCount = 0;
function showLoader(){ loadingCount++; els.progress.classList.remove('hidden'); }
function hideLoader(){ loadingCount = Math.max(0, loadingCount-1); if(loadingCount===0) els.progress.classList.add('hidden'); }
function setBusy(b){
  [els.btnAdd,els.btnRefresh1,els.btnProcess,els.btnRefreshPanels,els.btnClean].forEach(x=>x&&(x.disabled=b));
  if(b) showLoader(); else hideLoader();
}

/* ===================== NAV ===================== */
els.tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    els.tabBtns.forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.tab;
    els.tab1.style.display = id==='tab1' ? 'block' : 'none';
    els.tab2.style.display = id==='tab2' ? 'block' : 'none';
  });
});

/* ===================== DATA (Panels) ===================== */
let PANELS = []; // {PanelName, PanelCode, Active}
let PANEL_OPTIONS_HTML = '';

async function loadPanels(){
  showLoader();
  try{
    const res = await apiPost({action:'listPanels'});
    if(!res || !res.ok){ console.error(res); return; }
    PANELS = (res.panels||[]).filter(p=>p.PanelName);
    buildPanelOptions();
    renderPanelTable(true);
    const activeCount = PANELS.filter(p=>p.Active!==false).length;
    els.panelSummary.textContent = `Jumlah panel aktif: ${activeCount}`;
  } finally { hideLoader(); }
}
function buildPanelOptions(){
  const actives = PANELS.filter(p=>p.Active!==false);
  PANEL_OPTIONS_HTML = `<option value="">— pilih panel —</option>` +
    actives.map(p => `<option value="${escapeHtml(p.PanelCode)}">${escapeHtml(p.PanelName)} — ${escapeHtml(p.PanelCode)}</option>`).join('');
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]))}

/* ===================== TAB 1 – CRUD Panel (termasuk tukar kod) ===================== */
function renderPanelTable(fromLoad=false){
  const q = els.searchPanel.value.trim().toLowerCase();
  const rows = PANELS
    .filter(p => !q || (String(p.PanelName).toLowerCase().includes(q) || String(p.PanelCode).toLowerCase().includes(q)))
    .map((p,i)=> rowPanel(p,i));
  els.panelTBody.innerHTML = '';
  rows.forEach(tr => els.panelTBody.appendChild(tr));
}
function rowPanel(p, idx){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><strong>${idx+1}</strong></td>
    <td><span class="mono">${escapeHtml(p.PanelName)}</span></td>
    <td><span class="mono">${escapeHtml(p.PanelCode)}</span></td>
    <td>${p.Active!==false?'<span class="ok">Ya</span>':'<span class="err">Tidak</span>'}</td>
    <td>
      <button class="btn3">Edit</button>
      <button class="btn3" style="margin-left:8px">Padam</button>
    </td>`;
  const btnEdit = tr.children[4].children[0];
  const btnDel  = tr.children[4].children[1];

  btnEdit.addEventListener('click', ()=>{
    tr.innerHTML = `
      <td><strong>${idx+1}</strong></td>
      <td><input type="text" value="${escapeHtml(p.PanelName)}" style="width:100%"/></td>
      <td><input type="text" value="${escapeHtml(p.PanelCode)}" style="width:180px"/></td>
      <td><label style="display:flex;gap:6px;align-items:center"><input type="checkbox" ${p.Active!==false?'checked':''}/> Aktif</label></td>
      <td>
        <button class="btn3">Simpan</button>
        <button class="btn3" style="margin-left:8px">Batal</button>
      </td>`;
    const inputName = tr.children[1].querySelector('input');
    const inputCode = tr.children[2].querySelector('input');
    const chkActive = tr.children[3].querySelector('input[type="checkbox"]');
    const bSave = tr.children[4].children[0];
    const bCancel = tr.children[4].children[1];

    bSave.addEventListener('click', async ()=>{
      const newName = inputName.value.trim();
      const newCode = inputCode.value.trim();
      if(!newName || !newCode){ alert('Nama & Kod wajib.'); return; }
      setBusy(true);
      try{
        if (newCode !== p.PanelCode) {
          const r1 = await apiPost({action:'renamePanelCode', oldCode:p.PanelCode, newCode:newCode});
          if(!r1 || !r1.ok){ throw new Error(r1 && r1.error || 'Gagal tukar kod'); }
          const r2 = await apiPost({action:'updatePanel', panelCode:newCode, newName:newName, active:chkActive.checked});
          if(!r2 || !r2.ok){ throw new Error(r2 && r2.error || 'Gagal kemaskini panel'); }
        } else {
          const r = await apiPost({action:'updatePanel', panelCode:p.PanelCode, newName:newName, active:chkActive.checked});
          if(!r || !r.ok){ throw new Error(r && r.error || 'Gagal kemaskini panel'); }
        }
        await refreshPanelsBoth();
      }catch(e){
        alert(String(e.message||e));
      }finally{ setBusy(false); }
    });
    bCancel.addEventListener('click', renderPanelTable);
  });

  btnDel.addEventListener('click', async ()=>{
    if(!confirm('Padam panel ini?')) return;
    setBusy(true);
    const res = await apiPost({action:'deletePanel', panelCode:p.PanelCode});
    setBusy(false);
    if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal padam panel'); return; }
    await refreshPanelsBoth();
  });

  return tr;
}

els.btnAdd.addEventListener('click', async ()=>{
  const name = els.panelName.value.trim();
  const code = els.panelCode.value.trim();
  const active = els.panelActive.checked;
  if(!name || !code){ alert('Isi Nama Panel dan Kod Panel.'); return; }
  setBusy(true);
  const res = await apiPost({action:'createPanel', panelName:name, panelCode:code, active});
  setBusy(false);
  if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal tambah panel'); return; }
  els.panelName.value=''; els.panelCode.value='';
  await refreshPanelsBoth();
});
els.btnRefresh1.addEventListener('click', refreshPanelsBoth);
els.searchPanel.addEventListener('input', renderPanelTable);

async function refreshPanelsBoth(){
  showLoader();
  try{
    const res = await apiPost({action:'listPanels'});
    if(res && res.ok){
      PANELS = (res.panels||[]).filter(p=>p.PanelName);
      buildPanelOptions();
      renderPanelTable();
      const activeCount = PANELS.filter(p=>p.Active!==false).length;
      els.panelSummary.textContent = `Jumlah panel aktif: ${activeCount}`;
    }
  } finally { hideLoader(); }
}

/* ===================== TAB 2 – Upload & Export ===================== */
let filesQueue = []; // {id,name,text,panelCode,auto,status}

function buildPanelKeys(){
  const actives = PANELS.filter(p=>p.Active!==false);
  return actives.map(p=>{
    const code = String(p.PanelCode||'').toUpperCase();
    const name = String(p.PanelName||'').toUpperCase();
    const clean = name.replace(/[^A-Z0-9 ]/g,' ').replace(/\s+/g,' ').trim();
    const words = clean.split(' ').filter(w=>w.length>=3);
    const acronym = (name.match(/\b[A-Z]{2,}\b/g)||[]).join(' ');
    const keys = new Set([code, ...words]);
    if(acronym) acronym.split(' ').forEach(k=>keys.add(k));
    if(words.length) keys.add(words[0]);
    return {code, name, keys:[...keys]};
  });
}
function detectPanelFromFilename(fname){
  const stem = fname.split('/').pop().replace(/\.[^.]+$/,'').toUpperCase();
  const cands = buildPanelKeys();
  let best=null;
  for(const c of cands){
    for(const k of c.keys){
      if(!k) continue;
      if(stem.includes(k)){ const score=k.length; if(!best||score>best.score) best={code:c.code,score}; }
    }
  }
  return best?best.code:'';
}

function addFiles(list){
  const arr = Array.from(list||[]);
  if(!arr.length) return;
  els.fileTable.style.display = 'table';
  arr.forEach(f=>{
    if(!/\.csv$/i.test(f.name)) return;
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random();
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = String(reader.result||'');
      const code = detectPanelFromFilename(f.name);
      filesQueue.push({id,name:f.name,text, panelCode:code||'', auto:!!code, status:'Ready'});
      renderQueue();
    };
    reader.readAsText(f);
  });
}
function renderQueue(){
  els.fileTBody.innerHTML = '';
  filesQueue.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${idx+1}</strong></td>
      <td><div class="mono">${escapeHtml(it.name)}</div><div class="muted" style="font-size:13px">${it.auto?'auto':'manual'}${it.panelCode?` · ${escapeHtml(it.panelCode)}`:''}</div></td>
      <td></td>
      <td><span class="${it.status==='OK'?'ok':(it.status==='Ready'?'':'err')}">${escapeHtml(it.status)}</span></td>
      <td><button class="btn3">Buang</button></td>`;
    const tdSel = tr.children[2];
    const sel = document.createElement('select');
    sel.innerHTML = PANEL_OPTIONS_HTML;
    sel.value = it.panelCode || '';
    sel.onchange = e=>{ it.panelCode = e.target.value; it.auto=false; renderQueue(); };
    tdSel.appendChild(sel);
    tr.children[4].children[0].onclick = ()=>{ filesQueue = filesQueue.filter(x=>x.id!==it.id); renderQueue(); };
    els.fileTBody.appendChild(tr);
  });
  els.btnProcess.disabled = !filesQueue.some(x=>x.panelCode);
}

async function processAll(){
  const missing = filesQueue.filter(x=>!x.panelCode);
  if(missing.length){ alert('Sila pilih Panel untuk semua fail.'); return; }
  setBusy(true);
  let res;
  try{
    res = await apiPost({ action:'processCsvFiles', files: filesQueue.map(x=>({name:x.name, content:x.text, panelCode:x.panelCode})) });
  }catch(e){
    setBusy(false); alert('Ralat rangkaian/API.'); return;
  }
  setBusy(false);
  if(!res || !res.ok){ console.error(res); alert('Proses gagal: ' + (res && res.error || 'Unknown')); return; }
  (res.files||[]).forEach(f=>{ filesQueue.forEach(q=>{ if(q.panelCode===f.panelCode) q.status='OK'; }); });
  renderQueue();
  renderResults(res.files||[]);
}
function renderResults(files){
  els.outWrap.style.display = 'block';
  els.cards.innerHTML = '';
  els.exportMeta.textContent = files.length ? `${files.length} fail dijana` : 'Tiada fail dijana';
  files.forEach(f=>{
    const div = document.createElement('div'); div.className='cardItem';
    div.innerHTML = `
      <div style="font-weight:800">${escapeHtml(f.filename)}</div>
      <div class="muted" style="font-size:14px;margin-top:6px">
        Panel: <b>${escapeHtml(f.panelName || f.panelCode)}</b><br/>
        Baris: ${f.rows} · Jumlah (batch): ${Number(f.amountSum||0).toLocaleString('en-MY')}
      </div>
      <a class="dl" target="_blank" rel="noopener" href="${escapeHtml(f.downloadUrl)}">Muat turun</a>`;
    els.cards.appendChild(div);
  });
}

/* ===================== Clean Now ===================== */
async function cleanNow(){
  if(!confirm('Padam SEMUA eksport (.xlsx) dalam folder eksport? (Ke Trash)')) return;
  setBusy(true);
  let res;
  try{ res = await apiPost({action:'cleanupExportsNow', includeRoot:true}); }
  catch(e){ setBusy(false); alert('Ralat rangkaian/API.'); return; }
  setBusy(false);
  alert('Cleanup siap. Dipadam: ' + (res && res.deleted || 0));
}

/* ===================== Events & Init ===================== */
// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.tab;
    els.tab1.style.display = id==='tab1' ? 'block':'none';
    els.tab2.style.display = id==='tab2' ? 'block':'none';
  });
});

// Panel CRUD
els.btnAdd.addEventListener('click', async ()=>{
  const name = els.panelName.value.trim();
  const code = els.panelCode.value.trim();
  const active = els.panelActive.checked;
  if(!name || !code){ alert('Isi Nama Panel dan Kod Panel.'); return; }
  setBusy(true);
  const res = await apiPost({action:'createPanel', panelName:name, panelCode:code, active});
  setBusy(false);
  if(!res || !res.ok){ alert(res && res.error ? res.error : 'Gagal tambah panel'); return; }
  els.panelName.value=''; els.panelCode.value='';
  await refreshPanelsBoth();
});
els.btnRefresh1.addEventListener('click', refreshPanelsBoth);
els.searchPanel.addEventListener('input', renderPanelTable);

// Upload
els.btnRefreshPanels.addEventListener('click', refreshPanelsBoth);
els.btnProcess.addEventListener('click', processAll);
els.btnClean.addEventListener('click', cleanNow);

// Dropzone
els.drop.addEventListener('click', ()=> els.fileInput.click());
els.fileInput.addEventListener('change', e=> addFiles(e.target.files));
['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag');}));
els.drop.addEventListener('drop', e=>{ const dt=e.dataTransfer; if(dt&&dt.files) addFiles(dt.files); });

// Boot
loadPanels();
</script>
</body>
</html>
